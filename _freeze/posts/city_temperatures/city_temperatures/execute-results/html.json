{
  "hash": "c8220c40409eea947c01bd67ba1ec9fc",
  "result": {
    "markdown": "---\ntitle: \"Cities with Nice Weather\"\ndate: \"2022-05-12\"\ndescription: \"A meteorological meditation.\"\nimage: \"city_temperatures.jpg\"\n---\n\n\n\n\n## Introduction\n\nI live near [Toronto](https://en.wikipedia.org/wiki/Toronto#Climate). It's springtime, and currently about 30 °C. In my opinion, Toronto is too hot in the summer and too cold in the winter. I'd like to know which cities have the least deviation from a tolerable average temperature.\n\n## Tools\n\nThis page was created using [Quarto](https://quarto.org/). I'm using the [`tidyverse`](https://www.tidyverse.org/) for data wrangling, [`ggplot2`](https://ggplot2.tidyverse.org/) and [`ggExtra`](https://exts.ggplot2.tidyverse.org/ggExtra.html) to plot.\n\n## Data\n\nFirst, I created a CSV file comprising all the information in the Wikpedia article [List of cities by average temperature](https://en.wikipedia.org/wiki/List_of_cities_by_average_temperature).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nread_csv(\"temps.csv\", show_col_types = FALSE) ->\n  city_temps\n\nhead(city_temps)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 15\n  Country City         Jan   Feb   Mar   Apr   May   Jun   Jul   Aug   Sep   Oct\n  <chr>   <chr>      <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 Algeria Algiers     11.2  11.9  12.8  14.7  17.7  21.3  24.6  25.2  23.2  19.4\n2 Algeria Tamanrass…  12.8  15    18.1  22.2  26.1  28.9  28.7  28.2  26.5  22.4\n3 Algeria Reggane     16    18.2  23.1  27.9  32.2  36.4  39.8  38.4  35.5  29.2\n4 Angola  Luanda      26.7  28.5  28.6  28.2  27    23.9  22.1  22.1  23.5  25.2\n5 Benin   Cotonou     27.3  28.5  28.9  28.6  27.8  26.5  25.8  25.6  26    26.7\n6 Benin   Parakou     26.5  28.7  29.6  29    27.5  26.1  25.1  24.7  25    26.1\n# ℹ 3 more variables: Nov <dbl>, Dec <dbl>, Year <dbl>\n```\n:::\n:::\n\n\nEach row corresponds to a distinct city. There are two text columns containing each city's name and country, twelve numeric columns indicating the \"averages of the daily highs and lows\"[^1] for each month, and one additional numeric column containing the same figure for the entire year. The units are degrees Celsius. 455 cities are included in the data.\n\n[^1]: This is a bit ambiguous, but no matter. The article also points out that \"the actual daytime temperature in a given month will be 3 to 10 °C higher than the temperature listed here, depending on how large the difference between daily highs and lows is.\"\n\nWe'll define the \"deviation\" mentioned above as the difference between the value recorded for the coldest and hottest months, and the \"average\" as the value recorded for the whole year overall.\n\nWe'll ignore any other weather characteristics like humidity, rain, wind, diurnal temperature difference, etc.[^2]\n\n[^2]: This may or many not be reasonable depending on your personal preferences about weather.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncity_temps |>\n  rename_with(tolower) |>\n  rowwise() |>\n  transmute(city,\n            avg = year,\n            range = max(c_across(jan:dec)) - min(c_across(jan:dec))) ->\n  city_temps\n\nhead(city_temps)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 3\n# Rowwise: \n  city          avg range\n  <chr>       <dbl> <dbl>\n1 Algiers      17.4 14   \n2 Tamanrasset  21.7 16.1 \n3 Reggane      28.3 23.8 \n4 Luanda       25.8  6.5 \n5 Cotonou      27.2  3.30\n6 Parakou      26.8  4.9 \n```\n:::\n:::\n\n\n## Summary Statistics\n\nNow we can investigate the distribution of each of our two variables.\n\nHere are the default summaries:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncity_temps |> \n  select(avg, range) |>\n  summarize()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n          N    Mean   SD     Min    Q1 Median    Q3  Max\n1   avg 455   18.00 8.12   -14.4 12.45   18.6 25.65 30.5\n2 range 455   13.75 9.53     0.7  5.65   12.1 21.00 58.1\n```\n:::\n:::\n\n\nWhich cities correspond to the extremes for each variable?\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncity_temps |>\n  filter(\n    avg   %in% (city_temps |> pull(avg)   |> range())  || \n    range %in% (city_temps |> pull(range) |> range())) |>\n  arrange(avg)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4 × 3\n# Rowwise: \n  city         avg  range\n  <chr>      <dbl>  <dbl>\n1 Gjoa Haven -14.4 42    \n2 Yakutsk     -8.8 58.1  \n3 Honiara     26.5  0.700\n4 Assab       30.5  8.7  \n```\n:::\n:::\n\n\nLet's see the values for Toronto as a baseline, and save them for later:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncity_temps |>\n  filter(city == \"Toronto\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 × 3\n# Rowwise: \n  city      avg range\n  <chr>   <dbl> <dbl>\n1 Toronto   9.4    26\n```\n:::\n\n```{.r .cell-code}\ncity_temps |>\n  filter(city == \"Toronto\") |>\n  pull(avg) ->\n  toronto_avg\n\ncity_temps |>\n  filter(city == \"Toronto\") |>\n  pull(range) ->\n  toronto_range\n```\n:::\n\n\nBy global standards, Toronto is cool on average, but in keeping with my subjective perception, the deviation from that average over the year is quite large.\n\n## Plots\n\nLet's look at a scatter plot with marginal histograms:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncity_temps |>\n  ggplot(aes(x = avg, y = range)) +\n  geom_point(alpha = 0.33) +\n  geom_vline(xintercept = toronto_avg,\n             linetype = \"dashed\",\n             alpha = 0.33) +\n  geom_hline(yintercept = toronto_range,\n             linetype = \"dashed\",\n             alpha = 0.33) +\n  labs(title = \"Average Temperature vs Range by City\",\n       x = \"Average Temperature (°C)\",\n       y = \"Difference Between Hottest and Coldest Months (°C)\") ->\n  plot\n\nplot |>\n  ggMarginal(type = \"histogram\", fill = \"transparent\", size = 10) ->\n  plot\n\nplot\n```\n\n::: {.cell-output-display}\n![](city_temperatures_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\nHere Toronto is indicated by the dashed lines.\n\nWe can see there's a negative association between a city's average temperature and the range of temperatures experienced there. In particular, there's a big cluster of very hot cities which have little difference between their hottest and coldest months.\n\nTen tropical cities fall into both the hottest decile and the least varying decile:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncity_temps |> \n  filter(range < quantile(city_temps$range, 0.1),\n         avg   > quantile(city_temps$avg,   0.9)) |>\n  select(city)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 10 × 1\n# Rowwise: \n   city         \n   <chr>        \n 1 Lodwar       \n 2 Palembang    \n 3 Pontianak    \n 4 Kuala Lumpur \n 5 Malé         \n 6 Lanka Colombo\n 7 Oranjestad   \n 8 Willemstad   \n 9 Panama City  \n10 Barranquilla \n```\n:::\n:::\n\n\nWhile these cities see very little temperature variation throughout the year, they are much too hot.\n\n## Zooming In\n\nThe area of this plot I'm most interested in is the vertical slice around Toronto. Let's see the same plot, including only the cities within one degree of Toronto's average temperature.[^3] We'll exclude the marginal histograms but add labels to the cities.\n\n[^3]: I haven't defined an ideal average temperature, but any city with a similar average and smaller range than Toronto is a clear improvement.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncity_temps |>\n  filter(abs(avg - toronto_avg)<=1) |>\n  ggplot(aes(x = avg, y = range, label = city)) +\n  geom_point(alpha = 0.33) +\n  geom_text(size = 4, nudge_x = 0.01, hjust = \"left\") +\n  geom_vline(xintercept = toronto_avg,\n             linetype = \"dashed\",\n             alpha = 0.33) +\n  geom_hline(yintercept = toronto_range,\n             linetype = \"dashed\",\n             alpha = 0.33) +\n  labs(title = \"Average Temperature vs Range by City (Detail 1)\",\n       x = \"Average Temperature (°C)\",\n       y = \"Difference Between Hottest and Coldest Months (°C)\")\n```\n\n::: {.cell-output-display}\n![](city_temperatures_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\nSo it seems that [La Paz](https://en.wikipedia.org/wiki/La_Paz#Climate), [Edinburgh](https://en.wikipedia.org/wiki/Edinburgh#Climate), or [Dublin](https://en.wikipedia.org/wiki/Dublin#Climate) might be good options.\n\nBut which cities are the *best*? These would be the ones with the smallest range for a given maximum average. Let's find them.\n\n## Finding the Cities with the Nicest Weather\n\nWe want to know, for each maximum average temperature, the city that has the minimum range of temperatures. These are the cities that form the \"bottom-left edge\" of our first plot.\n\nNine cities fit this criterion:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncity_temps |>\n  arrange(avg) |>\n  cbind(city_temps |> arrange(avg) |> pull(range) |> cummin()) |>\n  rename(running_min = 4) |>\n  filter(range == running_min) |>\n  select(city)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n        city\n1 Gjoa Haven\n2     Dikson\n3       Nuuk\n4  Reykjavík\n5    Stanley\n6     La Paz\n7      Cusco\n8     Bogotá\n9    Honiara\n```\n:::\n:::\n\n\nOf these, the first two have temperatures which are more variable than Toronto, so we can remove them from consideration.\n\nLet's plot the final seven candidates:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncity_temps |>\n  arrange(avg) |>\n  cbind(city_temps |> arrange(avg) |> pull(range) |> cummin()) |>\n  rename(running_min = 4) |>\n  filter(range == running_min) |>\n  select(-running_min) |>\n  filter(range <= toronto_range) |>\n  ggplot(aes(x = avg, y = range, label = city)) +\n  geom_point(alpha = 0.33) +\n  geom_text(size = 4, nudge_x = 0.5, hjust = \"left\") +\n  geom_vline(xintercept = toronto_avg,\n             linetype = \"dashed\",\n             alpha = 0.33) +\n  scale_x_continuous(expand = expansion(mult = 0.15)) +\n    labs(title = \"Average Temperature vs Range by City (Detail 2)\",\n         x = \"Average Temperature (°C)\",\n         y = \"Difference Between Hottest and Coldest Months (°C)\")\n```\n\n::: {.cell-output-display}\n![](city_temperatures_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\nAgain we see that La Paz has a similar overall average temperature to Toronto, but much less annual variability. [Cusco](https://en.wikipedia.org/wiki/Cusco#Geography_and_climate) and [Bogotá](https://en.wikipedia.org/wiki/Bogot%C3%A1#Climate) are warmer but even less variable.\n\n[Reykjavík](https://en.wikipedia.org/wiki/Reykjav%C3%ADk#Climate) and [Stanley](https://en.wikipedia.org/wiki/Stanley,_Falkland_Islands#Climate) are colder than Toronto, and while they represent a smaller decrease in variability compared to La Paz, Cusco, and Bogotá, they have the benefit (for me) of being 98%+ English-speaking.\n\n[Nuuk](https://en.wikipedia.org/wiki/Nuuk#Climate) and [Honiara](https://en.wikipedia.org/wiki/Honiara#Geography_and_climate) are right out.\n\n## Next Steps\n\nIt would be interesting to use detailed time series for each city and a utility function on temperatures (perhaps including wind chill and humidex) to determine which cities are truly mean-variance optimal.\n\nOf course, one should probably not choose a place to live based solely on the weather.\n",
    "supporting": [
      "city_temperatures_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}